name: Deploy to Production
concurrency:
  group: production
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, Linux, ARM64]
    timeout-minutes: 10
    env:
      DOCKER_BUILDKIT: 1
      IMAGE_NAME: regedarek/balkonowaochrona
      CONTAINER_NAME: balkonowaochrona

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update -qq && sudo apt-get install -y jq
          fi
          if ! command -v bws &> /dev/null; then
            curl -L -o bws.zip "https://github.com/bitwarden/sdk-sm/releases/download/bws-v1.0.0/bws-aarch64-unknown-linux-gnu-1.0.0.zip"
            unzip -o bws.zip && chmod +x bws && sudo mv bws /usr/local/bin/ && rm bws.zip
          fi

      - name: Get Secrets from Bitwarden
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BW_ACCESS_TOKEN }}
        run: |
          KAMAL_REGISTRY_USERNAME=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_USERNAME }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          KAMAL_REGISTRY_PASSWORD=$(bws secret get ${{ secrets.BW_SECRET_REGISTRY_PASSWORD }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          RESEND_API_KEY=$(bws secret get ${{ secrets.BW_SECRET_BALKONOWAOCHRONA_RESEND_API_KEY }} --access-token "$BWS_ACCESS_TOKEN" | jq -r '.value')
          
          echo "KAMAL_REGISTRY_USERNAME=$KAMAL_REGISTRY_USERNAME" >> $GITHUB_ENV
          echo "KAMAL_REGISTRY_PASSWORD=$KAMAL_REGISTRY_PASSWORD" >> $GITHUB_ENV
          echo "RESEND_API_KEY=$RESEND_API_KEY" >> $GITHUB_ENV
          
          echo "✅ Secrets fetched"

      - name: Login to Docker Hub
        run: echo "$KAMAL_REGISTRY_PASSWORD" | docker login -u "$KAMAL_REGISTRY_USERNAME" --password-stdin

      - name: Build and push image
        run: |
          docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:${{ github.sha }} .
          docker push $IMAGE_NAME:latest
          docker push $IMAGE_NAME:${{ github.sha }}

      - name: Deploy container
        run: |
          docker pull $IMAGE_NAME:latest
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            --network host \
            -e PORT=4001 \
            -e TO_EMAIL=kalkowski123@gmail.com \
            -e FROM_EMAIL=onboarding@resend.dev \
            -e RESEND_API_KEY="$RESEND_API_KEY" \
            $IMAGE_NAME:latest
          
          sleep 3
          if docker ps | grep -q $CONTAINER_NAME; then
            echo "✅ Deployed successfully"
          else
            echo "❌ Deploy failed"
            docker logs $CONTAINER_NAME
            exit 1
          fi

      - name: Cleanup
        run: docker image prune -af --filter "until=24h" || true
        continue-on-error: true