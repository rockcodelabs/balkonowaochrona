#!/bin/bash
# Kamal secrets file
# Outputs secrets in KEY=VALUE format for Kamal to read

# Check if running in CI/CD (GitHub Actions)
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
  # In CI/CD, secrets come from environment variables
  echo "KAMAL_REGISTRY_USERNAME=${KAMAL_REGISTRY_USERNAME}"
  echo "KAMAL_REGISTRY_PASSWORD=${KAMAL_REGISTRY_PASSWORD}"
  echo "RESEND_API_KEY=${RESEND_API_KEY}"
  exit 0
fi

# Local development - fetch from Bitwarden CLI (bw)
if ! command -v bw &> /dev/null; then
  echo "Error: Bitwarden CLI (bw) not installed" >&2
  echo "Install: brew install bitwarden-cli" >&2
  exit 1
fi

# Check if vault is unlocked
BW_STATUS=$(bw status 2>/dev/null | jq -r '.status' 2>/dev/null)

if [ "$BW_STATUS" = "unauthenticated" ]; then
  echo "Error: Please login to Bitwarden: bw login" >&2
  exit 1
fi

if [ "$BW_STATUS" = "locked" ]; then
  echo "Error: Please unlock Bitwarden vault: export BW_SESSION=\$(bw unlock --raw)" >&2
  exit 1
fi

# Sync vault
bw sync > /dev/null 2>&1

# Fetch secrets from Bitwarden Password Manager
REGISTRY_USERNAME=$(bw get username registry-credentials 2>/dev/null)
REGISTRY_PASSWORD=$(bw get password registry-credentials 2>/dev/null)
RESEND_KEY=$(bw get notes kalkowski-resend 2>/dev/null)

# Verify all secrets were fetched
if [ -z "$REGISTRY_USERNAME" ] || [ -z "$REGISTRY_PASSWORD" ] || [ -z "$RESEND_KEY" ]; then
  echo "Error: Failed to fetch secrets from Bitwarden" >&2
  exit 1
fi

# Output secrets for Kamal
echo "KAMAL_REGISTRY_USERNAME=${REGISTRY_USERNAME}"
echo "KAMAL_REGISTRY_PASSWORD=${REGISTRY_PASSWORD}"
echo "RESEND_API_KEY=${RESEND_KEY}"