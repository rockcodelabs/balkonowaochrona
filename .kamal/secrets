#!/bin/bash
# Kamal secrets - local development
# Automatically fetches secrets from Bitwarden for local deployments
# For CI/CD, this file is ignored and GitHub Actions injects secrets directly

# Check if running in CI/CD (GitHub Actions handles secrets)
if [ -n "$CI" ] || [ -n "$GITHUB_ACTIONS" ]; then
  # In CI/CD, secrets come from environment (set by GitHub Actions workflow)
  export KAMAL_REGISTRY_USERNAME="${KAMAL_REGISTRY_USERNAME}"
  export KAMAL_REGISTRY_PASSWORD="${KAMAL_REGISTRY_PASSWORD}"
  export RESEND_API_KEY="${RESEND_API_KEY}"
  exit 0
fi

# Local development - fetch from Bitwarden CLI (bw)
if ! command -v bw &> /dev/null; then
  echo "❌ Bitwarden CLI (bw) not installed" >&2
  echo "Install: brew install bitwarden-cli" >&2
  exit 1
fi

# Check if vault is unlocked
BW_STATUS=$(bw status 2>/dev/null | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

if [ "$BW_STATUS" = "unauthenticated" ]; then
  echo "❌ Please login to Bitwarden: bw login" >&2
  exit 1
fi

if [ "$BW_STATUS" = "locked" ]; then
  echo "❌ Please unlock Bitwarden vault: export BW_SESSION=\$(bw unlock --raw)" >&2
  exit 1
fi

# Sync vault
bw sync > /dev/null 2>&1

# Fetch secrets from Bitwarden Password Manager
# Registry credentials (same as kw-app)
export KAMAL_REGISTRY_USERNAME=$(bw get username registry-credentials 2>/dev/null)
export KAMAL_REGISTRY_PASSWORD=$(bw get password registry-credentials 2>/dev/null)

# Resend API key (stored in notes field)
export RESEND_API_KEY=$(bw get notes kalkowski-resend 2>/dev/null)

# Verify all secrets were fetched
if [[ -z "$KAMAL_REGISTRY_USERNAME" ]] || [[ -z "$KAMAL_REGISTRY_PASSWORD" ]] || [[ -z "$RESEND_API_KEY" ]]; then
  echo "❌ Failed to fetch secrets from Bitwarden" >&2
  echo "" >&2
  echo "Please ensure these items exist in your Bitwarden vault:" >&2
  echo "  - registry-credentials (login with username/password)" >&2
  echo "  - kalkowski-resend (secure note with Resend API key)" >&2
  exit 1
fi

echo "✅ Secrets loaded from Bitwarden"